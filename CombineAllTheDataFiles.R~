library(dplyr)
library(tidyr)

# Set this directory to your project/Rscript location.
setwd("C:/Users/Ed/OneDrive/Documents/FSU/2025Fall/CSC-8008-DataExplorationAnalytics_Visualization/project")


# importing all data from 1990-2025 will create a csv 405 MB
# importing data files from 2000-2025 will create a csv file 397 MB
# importing data files from 2010-2025 will create a csv file 346 MB
# importing data files from 2020-2025 willc reate a csv file 273 MB
# CHANGE 1990:2025 to the range of years you want to use.
#set firstYear value to be the beginning year of data to pull in
firstYear <- 1990

#set lastYear value to be the last year desired 
lastYear <- 2025

# Function to read and combine a set of yearly files from the AllData folder
read_vaers_files <- function(prefix) {
  
  # the file.path should point to where you have uncompressed all the .csv files

  #dfs <- lapply(2010:2025, function(year) {
  dfs <- lapply(firstYear:lastYear, function(year) {
    filename <- file.path("AllData/", paste0(year, prefix, ".csv"))
    if (file.exists(filename)) {
      read.csv(filename, stringsAsFactors = FALSE)
    } else {
      NULL
    }
  })
  bind_rows(dfs)
}


# Read and combine each table type across all years
# it takes each year's Data, and then Symtpoms and then Vax csvs 
# and combines them into 3 separate dataframes.
vaers_data <- read_vaers_files("VAERSDATA")
vaers_symptoms <- read_vaers_files("VAERSSYMPTOMS")
vaers_vax <- read_vaers_files("VAERSVAX")


#Write out as backup

write.csv(vaers_data, paste0(firstYear, "-", lastYear, "_vaers_data.csv"),  row.names = FALSE)
write.csv(vaers_symptoms, paste0(firstYear, "-", lastYear, "_vaers_symptoms.csv"),  row.names = FALSE)
write.csv(vaers_vax, paste0(firstYear, "-", lastYear, "_vaers_vax.csv"),  row.names = FALSE)
# Merge the 3 master dataframes into one

# Collapse vaccines: one row per VAERS_ID with all vaccine types combined
# combines each vaccine given for each VAERS_ID
vax_collapsed <- vaers_vax %>%
  group_by(VAERS_ID) %>%
  summarise(
    VAX_TYPES = paste(unique(VAX_TYPE), collapse = ", "),
    VAX_NAMES = paste(unique(VAX_NAME), collapse = ", "),
    .groups = "drop"
  )

# Collapse symptoms: one row per VAERS_ID with all symptoms combined
# combines each vaccination's symptoms into 1 row each
symptoms_collapsed <- vaers_symptoms %>%
  group_by(VAERS_ID) %>%
  summarise(
    SYMPTOMS = paste(na.omit(c(SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5)), collapse = ", "),
    .groups = "drop"
  )

# Combine all three into one master dataframe
# creates the final dataframe that combines vacciness and all associated symptoms
# together into 1 row.
vaers_combined <- vaers_data %>%
  left_join(vax_collapsed, by = "VAERS_ID") %>%
  left_join(symptoms_collapsed, by = "VAERS_ID")



#clean up the data 

# Select important columns

# These should be the important fields.
# maybe LAB_DATA might have something, but very random field, so not included.
# OTHER_MEDS same as LAB_DATA, could try to clean up
# HISTORY should be compressed for "none" and clean up. but later.
# PRIOR_VAX seems to be random information, removing for now.
# ALLERGIES will be useful, need to clean up the data.

core_cols <- c("VAERS_ID", "RECVDATE", "AGE_YRS", "SEX", "VAX_NAMES", "SYMPTOMS", 
               "DIED", "HOSPITAL", "L_THREAT", "ER_VISIT", "DISABLE", "RECOVD",
                "OTHER_MEDS", "CUR_ILL", "HISTORY", "BIRTH_DEFECT", "ALLERGIES")


# new dataframe with desired columns 
cleaned_data <- vaers_combined %>% select(all_of(core_cols))

#Clean up the new dataframe

# Remove non-valid SEX values
cleaned_data <- cleaned_data %>% filter(SEX =='F' | SEX == 'M')

# remove non-valid ages, 110 year old should be the max
cleaned_data <- cleaned_data %>% filter(between(AGE_YRS, 0.00, 110.0))


#Used for cleaning up ALLERGIES data.
bad_codes <- c("0", "-", ".", "?")

cleaned_data <- cleaned_data %>%
  mutate(
    # clear out the bad data in ALLERGIES
    ALLERGIES = case_when(
      is.na(ALLERGIES) ~ "",
      ALLERGIES %in% bad_codes ~ "", 
      TRUE ~ ALLERGIES
    ),
    # DIED should only be Y or N, anything other than Y = N
    DIED = case_when(
      DIED == 'Y' ~ 'Y',
      TRUE        ~ 'N'
    ),
    # DISABLE only care about Y, non-Y should be N
    DISABLE = case_when(
      DISABLE == 'Y' ~ 'Y',
      TRUE          ~ 'N'
    ),
    #RECOVD, N is important, otherwise assume Y they recovered
    RECOVD  = case_when(
      RECOVD == 'N' ~ 'N',
      TRUE          ~ 'Y'
    ),
    #Did the paitent have to go to the ER or not.
    ER_VISIT = case_when(
      ER_VISIT == 'Y' ~ 'Y',
      TRUE          ~ 'N'
    ),
    #Does the paitent have a birth defect or not
    BIRTH_DEFECT = case_when(
      BIRTH_DEFECT == 'Y' ~ 'Y',
      TRUE        ~ 'N'
    ),
    #did the paitent get admited to the hospital
    HOSPITAL = case_when(
      HOSPITAL == 'Y' ~ 'Y',
      TRUE        ~ 'N'
    )
    
  )

#write out the new csv file
write.csv(vaers_data, paste0(firstYear, "-", lastYear, "_Cleaned_Vaers_data.csv"),  row.names = FALSE)


# Inspect the structure

# View the structure of the dataframe (column names, types, and examples)
str(vaers_combined)


# Column names only
colnames(vaers_combined)

# How many rows and columns
dim(vaers_combined)

# Show the first few rows
head(vaers_combined)

# Show the last few rows
tail(vaers_combined)

#Summary:

vaers_summary <- list(
  total_reports = nrow(vaers_combined),
  
  gender_counts = vaers_combined %>%
    count(SEX, sort = TRUE),
  
  age_stats = vaers_combined %>%
    summarise(
      mean_age = mean(AGE_YRS, na.rm = TRUE),
      median_age = median(AGE_YRS, na.rm = TRUE),
      min_age = min(AGE_YRS, na.rm = TRUE),
      max_age = max(AGE_YRS, na.rm = TRUE),
      .groups = "drop"
    ),
  
  top_vax_types = vaers_combined %>%
    separate_rows(VAX_TYPES, sep = ",\\s*") %>%
    count(VAX_TYPES, sort = TRUE) %>%
    slice_head(n = 10),
  
  top_symptoms = vaers_combined %>%
    separate_rows(SYMPTOMS, sep = ",\\s*") %>%
    count(SYMPTOMS, sort = TRUE) %>%
    slice_head(n = 10),
  
  serious_outcomes = vaers_combined %>%
    summarise(
      deaths = sum(DIED == "Y", na.rm = TRUE),
      hospitalized = sum(HOSPITAL == "Y", na.rm = TRUE),
      life_threat = sum(L_THREAT == "Y", na.rm = TRUE),
      disabled = sum(DISABLE == "Y", na.rm = TRUE),
      recovered = sum(RECOVD == "Y", na.rm = TRUE),
      .groups = "drop"
    )
)

print(vaers_summary)
